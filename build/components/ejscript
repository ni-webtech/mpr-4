#
#   ejscript - Ejscript language
#
defineComponent() {
    local deps libs optional path libdir builtin imports incdir iflags present SHOBJ type

    path="${1:-.}"
    eval SHOBJ=\$BLD_${kind}_SHOBJ
    builtin=`[ "$path" = "." -a -f src/ejs.h ] && echo --builtin`
    eval sqlite=\$CFG_${kind}_SQLITE

    optional="ssl"
    deps="mpr http"
    libs="ejs pcre"
    withlibs="pcre"

    if [ "$sqlite" = 1 ] ; then
        withlibs="sqlite3"
        libs="$libs sqlite3"
    fi
    if [ "$BLD_FEATURE_EJSCRIPT_ALL_IN_ONE" = 1 ] ; then
        if isdefined SQLITE ; then
            optional="$optional sqlite3"
        fi
    fi

    #
    #   If building via the build farm, do an on-demand build of ejs
    #
    : ${BUILD_DEPTH:=0}
    if [ "$BUILD_KEY" != "" -a "$BUILD_DEPTH" -ge 2 ] ; then
        if [ "${CMD_LINE/--with-ejscript}" != "${CMD_LINE}" ] ; then
            if [ ! -x imports/ejs/out/bin ] ; then
                echo "Downloading ..."
                rm -fr imports/ejs
                rm -f imports/packages
                mkdir -p imports
                ln -s ../extensions imports/packages
                git clone git@github.com:embedthis/ejs-2.git imports/ejs
                if [ "$BLD_DEBUG" = 1 ] ; then
                    (cd imports/ejs >/dev/null ; ./configure --debug ; make; echo)
                else
                    (cd imports/ejs >/dev/null ; ./configure --release ; make; echo)
                fi
            fi
        fi
    fi

    if [ "$builtin" = "" ] ; then
        search="$path/out/lib:$path/out/bin:$path/out/inc:$path"
        if [ "${path}" = "." ] ; then
            if [ -x "imports/ejs/out/bin" ] ; then
                search="${search}:imports/ejs/out/lib"
                search="${search}:imports/ejs/out/inc"
                search="${search}:imports/ejs/out/bin"
            fi
        fi
        libdir=`probe --name libejs --dir --search "$search" "libejs"`
        if [ "$libdir" = "" -a "$path" != "." ] ; then
            warnComponent ejscript "Can't locate libejs"
            return
        fi
        for lib in `echo $libdir/libejs* $libdir/libmpr* $libdir/libhttp* $libdir/libpcre* $libdir/ejs*${SHOBJ} \
                $libdir/libsqlite3*` ; do
            if [ ! -f "$lib" ] ; then
                warnComponent ejscript "Ejscript is not correctly built. Missing $lib"
                return
            fi
            libraries="$lib $libraries"
        done
        if [ "$BLD_FEATURE_EJSCRIPT_ALL_IN_ONE" = 1 ] ; then
            if isdefined SQLITE ; then
                libraries="$libraries `echo $libdir/libsqlite3*`"
            fi
        fi
        ejsbin=`probe --exe --name ejs --search "$search" ejs`

        if [ "$libdir" != "" ] ; then
            imports="$libraries"
            modules=`echo $libdir/*.mod`
            imports="$imports $modules"
            #
            #   Import manager, http and makerom as they come from the MPR and Http libraries which Ejscript supplies
            #
            manager=`probe --exe --name manager --search "$search" manager`
            if [ "$manager" != "" ] ; then
                imports="$imports $manager"
            fi
            http=`probe --exe --name http --search "$search" http`
            if [ "$http" != "" ] ; then
                imports="$imports $http"
            fi
            makerom=`probe --exe --name makerom --search "$search" makerom`
            if [ "$makerom" != "" ] ; then
                imports="$imports $makerom"
            fi
            # UNUSED - Don't hard link to ejs.web
            # libs="$libs ejs.web"
        else
            optional=
            libs=
            withlibs=
            deps=
            present="--present 0"
        fi
    else
        ejsbin=`canonPath ${BLD_OUT_DIR}/bin/ejs`
    fi
    incdir=`probe --name ejs.h --dir --search "$search" "ejs.h" `
    if [ "$incdir" != "" ] ; then
        headers="`echo $incdir/ejs*.h`"
        imports="$imports $headers"
        if [ "$builtin" = "" ] ; then
            headers="`echo $incdir/http.h $incdir/mpr*.h $incdir/pcre.h`"
            imports="$imports $headers"
        fi
    fi
    configureComponent --libs "$libs" --iflags "$iflags" --libpaths "$libdir" --withlibs "$withlibs" \
        $builtin $present --dependencies "$deps" --optional-dependencies "$optional" --imports "$imports" \
        --path "$ejslib" ejscript
}
